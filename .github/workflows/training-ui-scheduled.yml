name: Training UI Scheduled

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag filter regex, e.g. @smoke|@regression"
        required: false
        default: "@smoke|@regression"
      base_url:
        description: "Optional BASE_URL override for this manual run"
        required: false
        default: "http://127.0.0.1:3000"
      merge_reports:
        description: "Generate merged Playwright reports (HTML/JSON/JUnit)"
        required: false
        default: "false"
  schedule:
    - cron: "30 3 * * 1,3,5"

permissions:
  contents: read

env:
  CI: "true"

jobs:
  setup-auth:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.58.2-jammy
    env:
      BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:3000' }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: playwright-tests/pnpm-lock.yaml

      - name: Install app dependencies
        run: npm ci || npm install

      - name: Build app
        run: npm run build

      - name: Start app (production mode)
        run: npm run start > app.log 2>&1 &

      - name: Wait for app to be ready
        shell: bash
        run: |
          for i in {1..90}; do
            if curl -fsS "${BASE_URL}" >/dev/null; then
              echo "App is up"
              exit 0
            fi
            sleep 2
          done
          echo "App did not start in time"
          tail -n 200 app.log || true
          exit 1

      - name: Install Playwright workspace dependencies
        run: pnpm install --frozen-lockfile
        working-directory: playwright-tests

      - name: Create .state folder
        run: mkdir -p .state
        working-directory: playwright-tests

      - name: Create storage state
        run: pnpm exec playwright test specs/config/global.setup.ts --project=setup --grep "@SetupUI" --workers=1
        working-directory: playwright-tests

      - name: Verify storage state files exist
        shell: bash
        run: |
          test -f playwright-tests/.state/admin-state.json || (echo "Missing .state/admin-state.json" && exit 1)
          test -f playwright-tests/.state/qa-state.json || (echo "Missing .state/qa-state.json" && exit 1)

      - name: Upload storage state
        uses: actions/upload-artifact@v4
        with:
          name: storage-state
          path: playwright-tests/.state/
          if-no-files-found: error

  test-shards:
    needs: setup-auth
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.58.2-jammy
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: 1
            shard_arg: 1/3
          - id: 2
            shard_arg: 2/3
          - id: 3
            shard_arg: 3/3
    env:
      BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:3000' }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: playwright-tests/pnpm-lock.yaml

      - name: Install app dependencies
        run: npm ci || npm install

      - name: Build app
        run: npm run build

      - name: Start app (production mode)
        run: npm run start > app.log 2>&1 &

      - name: Wait for app to be ready
        shell: bash
        run: |
          for i in {1..90}; do
            if curl -fsS "${BASE_URL}" >/dev/null; then
              echo "App is up"
              exit 0
            fi
            sleep 2
          done
          echo "App did not start in time"
          tail -n 200 app.log || true
          exit 1

      - name: Install Playwright workspace dependencies
        run: pnpm install --frozen-lockfile
        working-directory: playwright-tests

      - name: Download storage state
        uses: actions/download-artifact@v4
        with:
          name: storage-state
          path: playwright-tests/.state

      - name: Run shard
        shell: bash
        working-directory: playwright-tests
        run: |
          export SHARD_LABEL="shard-${{ matrix.id }}"
          pnpm exec playwright test \
            --project=chromium \
            --grep "${{ github.event.inputs.tag || '@smoke|@regression' }}" \
            --grep-invert "@SetupUI" \
            --shard=${{ matrix.shard_arg }} \
            --workers=4

      - name: Upload shard artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.id }}-artifacts
          path: playwright-tests/artifacts/shard-${{ matrix.id }}/
          if-no-files-found: error

  merge-reports:
    needs: test-shards
    if: ${{ !cancelled() && github.event_name == 'workflow_dispatch' && github.event.inputs.merge_reports == 'true' }}
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:v1.58.2-jammy
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: playwright-tests/pnpm-lock.yaml

      - name: Install Playwright workspace dependencies
        run: pnpm install --frozen-lockfile
        working-directory: playwright-tests

      - name: Download shard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*-artifacts
          merge-multiple: true
          path: playwright-tests/downloaded

      - name: Merge blob reports
        shell: bash
        working-directory: playwright-tests
        run: |
          mkdir -p artifacts/merged/blob-input
          find downloaded -type f -path "*/blob/*.zip" -exec cp {} artifacts/merged/blob-input/ \;
          blob_count=$(find artifacts/merged/blob-input -type f -name "*.zip" | wc -l)
          if [ "$blob_count" -eq 0 ]; then
            echo "No blob report files found. Skipping merge-reports."
            exit 0
          fi
          pnpm exec playwright merge-reports --config=specs/utils/merge-reporter.config.ts artifacts/merged/blob-input

      - name: Upload merged reports
        uses: actions/upload-artifact@v4
        with:
          name: merged-reports
          path: playwright-tests/artifacts/merged/
          if-no-files-found: error
